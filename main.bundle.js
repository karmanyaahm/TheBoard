"use strict";(self.webpackChunktheboard_matrix=self.webpackChunktheboard_matrix||[]).push([[179],{784:(t,e,o)=>{function n(t){let e=t.clone(),o=e.bounds;e.position=e.position.subtract(o.topLeft);let n="";for(let t of e.segments)n+=t.point.x.toFixed(3)+" "+t.point.y.toFixed(3)+" "+t.handleIn.x.toFixed(3)+" "+t.handleIn.y.toFixed(3)+" "+t.handleOut.x.toFixed(3)+" "+t.handleOut.y.toFixed(3)+" ";return e.remove(),[o.topLeft,o.size,n.trim()]}function a(t,e){return Math.sqrt((t.x-e.x)**2+(t.y-e.y)**2)}function i(t){let e=(t||"0 0").split(" ");return new paper.Point(parseFloat(e[0]),parseFloat(e[1]))}function r(t,e){const o=Math.round(255*Math.min(Math.max(e||1,0),1)).toString(16).toUpperCase();return 7==t.length?t+o:9==t.length?(t[7]=o[0],t[8]=o[1],t):void 0}o.d(e,{Zk:()=>O,QP:()=>A,rB:()=>F,HS:()=>L});const s=o(3267);class l{constructor(){this.css_id="paper-canvas",this.displayPaths=[],this.toolLayer=null,this.drawLayer=null,this.canvas=null}drawEvent(t,e,o=!0){let n=appData.drawingCanvas;function a(){let a=function(t,e){let o=t.split(" ");var n=e.split(" "),a=[];for(let t=0;t<o.length;t+=4){let e=parseFloat(o[t]),i=parseFloat(o[t+1])+parseFloat(n[0]),r=parseFloat(o[t+2])+parseFloat(n[1]),s=parseFloat(o[t+3]);a.push([e,i,r,s])}return a}(t.content.path,t.content.objpos),r=i(t.content.objpos),s=i(t.content.objsize),l="objcolor"in t.content?t.content.objcolor:"#000";e?n.asyncAddPathV1([r.x,r.y],a,l):(n.drawBoundingBox([[r.x,r.y],s]),n.addPathV1(a,l,[[r.x,r.y],s],t.event_id),o&&n.updateDisplay_DEPRECATED(!0))}if("p.path"==t.content.objtype){if(!("version"in t.content))return void a();switch(t.content.version){case 1:a();case 2:!function(){let a=function(t,e){let o=t.split(" ");o=o.filter((t=>""!=t));var n=e.split(" "),a=[];for(let t=0;t<o.length;t+=6){let e=new paper.Segment(new paper.Point(parseFloat(o[t+0])+parseFloat(n[0]),parseFloat(o[t+1])+parseFloat(n[1])),new paper.Point(parseFloat(o[t+2]),parseFloat(o[t+3])),new paper.Point(parseFloat(o[t+4]),parseFloat(o[t+5])));a.push(e)}return a}(t.content.path,t.content.objpos),i=parseFloat(t.content.strokeWidth),r="closed"in t.content&&t.content.closed,s="objcolor"in t.content?t.content.objcolor:"#000",l="objFillColor"in t.content?t.content.objFillColor:"#00000000";e?(n.updateDisplay_DEPRECATED(!0),n.asyncAddPathV2(a,s,l,i,r,t.event_id)):(n.addPathV2(a,s,l,i,r,t.event_id),o&&n.updateDisplay_DEPRECATED(!0))}()}}}activateToolLayer(){this.toolLayer.activate()}activateDrawLayer(){this.drawLayer.activate()}init(){this.canvas=document.getElementById("paper-canvas"),s.setup(this.canvas),s.install(window),this.drawLayer=s.project.activeLayer,this.toolLayer=new s.Layer}offset(t){s.view.center=s.view.center.subtract(t)}resetOffset(){this.setOffset(new s.Point(0,0))}setOffset(t){s.view.center=t}getZoom(){return s.view.zoom}zoom(t,e){if(null===e)s.view.scale(t);else{var o=s.view.viewToProject(e);s.view.scale(t,o)}}setZoom(t,e=s.view.center){var o=s.view.center,n=s.view.viewToProject(e);s.view.center=n,s.view.zoom,s.view.zoom=t,s.view.center=o}resetZoom(){this.setZoom(1)}asyncAddPathV1(){console.log("WAIT WHAT???")}asyncAddPathV2(t,e,o,n,a=!1,i=""){let r=this.addPathV2(t,e,o,n,a,i),s=0;s=r.length,r.dashArray=[s,s],r.tween({dashOffset:s},{dashOffset:0},2*s).then((()=>{r.dashArray=[]}))}addPathV2(t,e,o,n,a=!1,i=""){var r=new s.Path(t);return r.strokeColor=e,r.fillColor=o,r.strokeWidth=n,r.strokeCap="round",r.closed=a,""!=i&&(r.data.id=i),r}addPathV1(t,e,[o,n],a=""){var i=new s.Path;i.strokeColor=e,i.strokeWidth=2,i.strokeCap="round",""!=a&&(i.data.id=a),i.moveTo(new s.Point(t[0][1],t[0][2]));for(let e=1;e<t.length;e++)i.lineTo(new s.Point(t[e][1],t[e][2]))}updateDisplay_DEPRECATED(){null!==this.dispPath&&(this.displayPaths.push(this.dispPath),this.dispPath=null)}clearDisplayPaths(){this.displayPaths.forEach((t=>{t.remove()}))}clear(){var t=0;for(let e of s.project.layers)e!==this.toolLayer&&(t+=e.removeChildren().length);console.log("removed ",t," items")}drawBoundingBox(t){}reload(t=!1){this.clear();var e=Date.now();console.log("!! Paper Canvas redraw START"),appData.objectStore.allSorted().forEach((e=>{"p.whiteboard.object"==e.type&&this.drawEvent(e,t,t)})),console.log("!! Paper Canvas redraw DONE in",Date.now()-e)}getTransformedPointer(t,e){return s.view.viewToProject(new s.Point(t,e))}}function c(t,e,o,n,a,i,r,s,l,c){console.log("send random path: ...");const d={version:c,svg:"none",objtype:"p.path",objpos:i[0]+" "+i[1],objsize:r[0]+" "+r[1],objcolor:""==n?"#"+["F55","5F5","55F"][Math.floor(3*Math.random())]:n,objFillColor:""==a?"#"+["F55","5F5","55F"][Math.floor(3*Math.random())]:a,path:o,strokeWidth:s,closed:l};t.sendEvent(e,"p.whiteboard.object",d,"",((t,e)=>{console.log(t)}))}function d(){let t=null,e=appData.matrixClient.client.getUserId(),o=appData.objectStore.allSorted();for(let n=o.length-1;n>=0;n--){let a=o[n];if(console.log("looping through events to find the one to redact"),"p.whiteboard.object"==a.type&&a.sender==e){t=a;break}}return t}function p(t,e){appData.matrixClient.client.sendEvent(appData.matrixClient.currentRoomId,"p.whiteboard.object",e,"",((t,e)=>{console.log(t)})),appData.matrixClient.client.redactEvent(appData.matrixClient.currentRoomId,t).then((t=>{console.log("redacted for replace ",t)}))}window.actions={redactLastAction:function(){let t="",e=appData.matrixClient.currentRoomId,o=appData.matrixClient.client.getUserId(),n=objectStore.allSorted();for(let e=n.length-1;""===t&&e>=0;e--){let a=n[e];if(console.log("looping through events to find the one to redact"),"p.whiteboard.object"==a.type&&a.sender==o){t=a.event_id;break}}client.redactEvent(e,t).then((t=>{console.log("redacted: ",t)}))},formSubmit:function(t){return t.preventDefault(),console.log("onsub"),!1},replaceLastEvent:function(){p(d().event_id,{version:2,svg:"none",objtype:"p.path",objpos:"100 100",objcolor:"#000",closed:!0,objFillColor:"#ff000030",strokeWidth:3,path:"0 0 0 0 0 0 0 100 0 0 0 0 100 100 0 0 0 0 100 0 0 0 0 0"})},moveLastEvent:function(){let t=d(),e=i(t.content.objpos).add(new paper.Point(100,0));t.content.objpos=e.x+" "+e.y,p(t.event_id,t.content)},showAddRoomMenu:function(){F(),document.getElementById("add-room-container").style.display="block"},hideAddRoomMenu:function(){document.getElementById("add-room-container").style.display="none"},showSettingsMenu:function(){let t=document.getElementById("settings-container"),e=document.getElementById("room-menu-room-id"),o=appData.matrixClient.client.getRoom(appData.matrixClient.currentRoomId);e.innerHTML=o.roomId,t.style.display="block"},hideSettingsMenu:function(){document.getElementById("settings-container").style.display="none"},toggleLeftBar:function(){let t=document.getElementById("leftbar-expand"),e=document.getElementById("leftbar-footer");0==t.getBoundingClientRect().height?(t.style.height="20em",e.innerHTML="˄"):(t.style.height="0",e.innerHTML="˅")}};var h=1;function m(){return h}let u;function v(){return u.getColor().toCSS(!0)}class g{constructor(){this.colors=["#999","#8ae234","#ef2929","#fcaf3e","#729fcf","#ad7fa8"],this.darkColors=this.colors.map((t=>new s.Color(t).multiply(.7))),this.darkColors[0]="black",this.outline=null,this.colorPaths=[[],[]],this.selectedColor=[0,0],this.COLOR_PICKER_BORDER=20,this.innerCircle=.35,this.middleCircle=.7,this.project=new s.Project("color-picker-canvas"),this.redraw()}redraw(){this.project.activate(),document.getElementById("color-picker-canvas");let t=s.view.size,e=new s.Point(t.divide(2)),o=t.width/2-this.COLOR_PICKER_BORDER,n=new s.Path.Circle(e,o);n.shadowBlur=this.COLOR_PICKER_BORDER,n.shadowColor="grey",n.fillColor="white",this.colorPaths[0]=this.create_segment_ring(this.colors,e,o*this.middleCircle-1,o,0),this.colorPaths[1]=this.create_segment_ring(this.darkColors,e,o*this.innerCircle,o*this.middleCircle,1);let a=new s.Path.Circle(e,this.innerCircle*o);a.shadowBlur=this.COLOR_PICKER_BORDER,a.shadowColor="#444",a.fillColor="white",s.projects[0].activate()}setColorPalette(t){this.colors=["#999"].concat(t),this.darkColors=this.colors.map((t=>new s.Color(t).multiply(.7))),this.darkColors[0]="black",this.redraw()}create_segment_ring(t,e,o,n,a){let i=t.length,r=Math.PI/i,s=[];for(let l=0;l<i;l++){let c=2*Math.PI/i*l-r,d=2*Math.PI/i*(l+1)-r,p=this.create_segment(e,o,n,c,d);p.fillColor=t[l],p.onMouseDown=function(t){u.selectColor([a,l])},s.push(p)}return s}create_segment(t,e,o,n,a){function i(t,e,o){let n=Math.sin(t)*o,a=-Math.cos(t)*o;return e.add(new s.Point(n,a))}let r=new s.Path,l=(n+a)/2;return r.moveTo(i(n,t,o)),r.arcTo(i(l,t,o),i(a,t,o)),r.lineTo(i(a,t,e)),r.arcTo(i(l,t,e),i(n,t,e)),r.closePath(),r}selectColor(t){this.selectedColor=t;let e=this.colorPaths[t[0]][t[1]];null!==this.outline&&this.outline.remove(),this.outline=e.clone(),this.outline.fillColor="#FFFFFF00",this.outline.strokeWidth=4,this.outline.bringToFront(),this.outline.strokeColor="white"}getColor(){return this.colorPaths[this.selectedColor[0]][this.selectedColor[1]].fillColor}}class w{constructor(t=!1){this.isMarker=t,this.mouse_path=[],this.mouse_path_last_time=Date.now(),this.last_pos=[],this.tool_canceled=!1,this.strokeWidthOptions=[1,2,4,8],this.previewItem=null,this.previewPaths=[],this.previewPathTween=null}getStrokeWidth(){return this.strokeWidthOptions[m()]*(this.isMarker?10:1)}getStrokeColor(){return this.isMarker?r(v(),.1):v()}tooldown(t,e,o){this.tool_canceled=!1,this.mouse_path_start_time=Date.now(),this.last_pos=[0,t,e,o],this.mouse_path=[[0,t,e,4*o]],appData.drawingCanvas.activateToolLayer();for(let t of this.previewPaths)t.visible||t.remove();this.previewPaths.filter((t=>{t.visible}));let n=new Path;this.previewPaths.push(n);let a=new Color(this.getStrokeColor());a.alpha=.6*a.alpha,n.strokeColor=a,n.strokeWidth=this.getStrokeWidth(),n.strokeCap="round",n.moveTo(new Point(t,e)),appData.drawingCanvas.activateDrawLayer(),console.log("tooldown")}toolmove(t,e,o){console.log("toolmove");let n=t,a=e,i=Math.min(80,Date.now()-this.mouse_path_last_time);this.mouse_path_last_time=Date.now();let r=[i,n,a,2+Math.min(3,Math.max(0,1))],s=(this.last_pos[1],this.last_pos[2],new Point(r[1],r[2]));this.mouse_path.push(r),this.previewPaths[this.previewPaths.length-1].lineTo(s),this.previewPaths[this.previewPaths.length-1].smooth(),this.last_pos=r}toolpreviewmove(t){null===this.previewItem&&(appData.drawingCanvas.activateToolLayer(),this.previewItem=new Path.Circle(new Point(0,0),.5),this.previewItem.applyMatrix=!1,appData.drawingCanvas.activateDrawLayer()),this.previewItem.scaling=new Point(this.getStrokeWidth(),this.getStrokeWidth()),this.previewItem.fillColor=this.getStrokeColor(),this.previewItem.position=t}toolup(t,e){if(!this.tool_canceled){if(appData.objectStore.hasRoom(appData.matrixClient.currentRoomId)){let t,e,[o,a,i]=function(t){let e=[Number.MAX_VALUE,Number.MAX_VALUE],o=[-Number.MAX_VALUE,-Number.MAX_VALUE];for(let n of t)e[0]=Math.min(e[0],n[1]),e[1]=Math.min(e[1],n[2]),o[0]=Math.max(o[0],n[1]),o[1]=Math.max(o[1],n[2]);let n=t.map((t=>[t[0],t[1]-e[0],t[2]-e[1],t[3]])),a=o[0]-e[0],i=o[1]-e[1];return[n,e,[a,i]]}(this.mouse_path);if(appData.drawingCanvas instanceof l){let a=new Path(o.map((t=>[t[1],t[2]])));a.simplify(1/appData.drawingCanvas.getZoom()),t=n(a)[2],a.remove(),e=2}c(appData.matrixClient.client,appData.matrixClient.currentRoomId,t,this.getStrokeColor(),"#00000000",a,i,this.getStrokeWidth(),!1,e)}else console.log("NO ROOM SELECTED TO DRAW IN!"),appData.drawingCanvas.updateDisplay_DEPRECATED();this.toolcancel()}}toolcancel(){console.log("CANCEL"),this.mouse_path=[],this.mouse_path_last_time=Date.now(),this.last_pos=[],this.tool_canceled=!0;let t=this.previewPaths[this.previewPaths.length-1],e=t.length;t.dashArray=[e,e],t.tween({dashOffset:0},{dashOffset:-e},2*e).then((e=>{t.visible=!1}))}activate(){this.previewItem&&(this.previewItem.visible=!0)}deactivate(){this.previewItem&&(this.previewItem.visible=!1)}}var f={"tool-type-pen":new w,"tool-type-eraser":new class{constructor(){this.removedElementsArray,this.tool_canceled=!1,this.idsToDelete=[],this.strokeWidthOptions=[5,10,20,40],this.previewItem=null}getStrokeWidth(){return this.strokeWidthOptions[m()]}tooldown(t,e,o){this.tool_canceled=!1,this.addItemsFromPoint(new paper.Point(t,e)),console.log("tooldown")}toolmove(t,e,o){console.log("toolmove"),this.addItemsFromPoint(new paper.Point(t,e))}addItemsFromPoint(t){for(var e={stroke:!0,tolerance:this.getStrokeWidth(),match:function(t){return!("markedForDeletion"in t.item.data)&&"id"in t.item.data}},o=paper.project.hitTest(t,e),n=0;o&&n<10;)o&&(console.log("hitResult",o),appData.objectStore.getById(o.item.data.id).sender==appData.matrixClient.client.getUserId()&&(o.item.opacity=.5,o.item.data.markedForDeletion=!0,this.idsToDelete.push(o.item.data.id),o=paper.project.hitTest(t,e)),n++)}toolup(t,e){if(!this.tool_canceled){this.toolcancel(),console.log(this.idsToDelete);for(let t of this.idsToDelete)console.log(t),appData.matrixClient.client.redactEvent(appData.matrixClient.currentRoomId,t).then((t=>{console.log("redacted (eraser): ",t)})),this.idsToDelete=this.idsToDelete.filter((e=>e==t));this.idsToDelete=[]}}toolcancel(){console.log("CANCEL"),this.tool_canceled=!0}toolpreviewmove(t){if(null===this.previewItem&&(appData.drawingCanvas.activateToolLayer(),this.previewItem=new paper.Path.Circle(new paper.Point(0,0),1),this.previewItem.fillColor="#00000000",this.previewItem.strokeWidth=1,this.previewItem.strokeColor="#999",this.previewItem.dashArray=[3,3],this.previewItem.strokeCap="round",appData.drawingCanvas.activateDrawLayer()),this.previewItem.bounds.size.width!=2*this.getStrokeWidth()){let t=2*this.getStrokeWidth()/this.previewItem.bounds.size.width;this.previewItem.scaling=new paper.Point(t,t)}this.previewItem.position=t}activate(){this.previewItem&&(this.previewItem.visible=!0)}deactivate(){this.previewItem.visible=!1}},"tool-type-marker":new w(!0),"tool-type-line":new class{constructor(){this.canvas_line=null,this.tool_canceled=!0,this.strokeWidthOptions=[1,2,4,8]}getStrokeWidth(){return this.strokeWidthOptions[m()]}tooldown(t,e,o){this.tool_canceled=!1;let n=new paper.Point(t,e);this.canvas_line=new paper.Path([n,n]);let a=r(v(),.3);this.canvas_line.strokeColor=a,this.canvas_line.strokeWidth=this.getStrokeWidth(),this.canvas_line.strokeCap="round",console.log("tooldown")}toolmove(t,e,o){console.log("toolmove"),this.canvas_line.lastSegment.point=new paper.Point(t,e)}toolup(t,e){if(!this.tool_canceled){if(appData.objectStore.hasRoom(appData.matrixClient.currentRoomId)){let[t,e,o]=n(this.canvas_line),a=2;c(appData.matrixClient.client,appData.matrixClient.currentRoomId,o,v(),"#00000000",[t.x,t.y],[e.width,e.height],this.getStrokeWidth(),!1,a)}else console.log("NO ROOM SELECTED TO DRAW IN!"),appData.drawingCanvas.updateDisplay_DEPRECATED();this.toolcancel()}}toolcancel(){console.log("CANCEL"),null!==this.canvas_line&&this.canvas_line.remove(),this.canvas_line=null,this.tool_canceled=!0}toolpreviewmove(t){}activate(){}deactivate(){}},"tool-type-square":new class{constructor(){this.canvas_rect=null,this.strokeWidthOptions=[1,2,4,8]}getStrokeWidth(){return this.strokeWidthOptions[m()]}tooldown(t,e,o){this.tool_canceled=!1;let n=new paper.Point(t,e);appData.drawingCanvas.activateToolLayer(),this.canvas_rect=new paper.Path.Rectangle(n,n);let a=r(v(),.3);this.canvas_rect.strokeColor=a,this.canvas_rect.strokeWidth=this.getStrokeWidth(),this.canvas_rect.strokeCap="round",appData.drawingCanvas.activateDrawLayer(),console.log("tooldown")}toolmove(t,e,o){console.log("toolmove"),this.canvas_rect.segments[1].point.x=t,this.canvas_rect.segments[2].point.x=t,this.canvas_rect.segments[2].point.y=e,this.canvas_rect.segments[3].point.y=e}toolup(t,e){if(!this.tool_canceled){if(appData.objectStore.hasRoom(appData.matrixClient.currentRoomId)){let[t,e,o]=n(this.canvas_rect),a=2;c(appData.matrixClient.client,appData.matrixClient.currentRoomId,o,v(),r(v(),.08),[t.x,t.y],[e.width,e.height],this.getStrokeWidth(),!0,a)}else console.log("NO ROOM SELECTED TO DRAW IN!"),appData.drawingCanvas.updateDisplay_DEPRECATED();this.toolcancel()}}toolcancel(){console.log("CANCEL"),null!==this.canvas_rect&&(this.canvas_rect.remove(),this.canvas_rect=null,this.tool_canceled=!0)}toolpreviewmove(t){}activate(){}deactivate(){}},"tool-type-ellipse":null,"tool-type-text":null,"tool-type-line-width":null},y=f["tool-type-pen"];function C(t){}function b(t){}var D=[],k=[],_=0,P=new DOMPoint(0,0);_=0,P=new DOMPoint(0,0);var I="",E=o(8743);class R{constructor(){this.notebooks={},this.whiteboards=[]}clear(){this.notebooks={},this.whiteboards=[]}}var x=o(3267);const T=document.createElement("template");T.innerHTML="\n<link href=\"style.css\" rel=\"stylesheet\" type=\"text/css\">\n<style>\n    span {\n        font-size: 3em;\n        white-space: pre;\n        font-weight: 100;\n    }\n    input {\n        width: 100%;\n        padding: 12px 20px;\n        margin: 8px 0;\n        display: inline-block;\n        border: 1px solid #ccc;\n        border-radius: 4px;\n        box-sizing: border-box;\n    }\n    button.submit {\n        width: 100%;\n        background-color: #FFAF50;\n        background-color: #4CAF50;\n        color: white;\n        padding: 14px 20px;\n        margin: 8px 0;\n        border: none;\n        border-radius: 4px;\n        cursor: pointer;\n    }\n</style>\n<div class='center-container' id='login-container'>\n    <p>\n        <span>The Board</span>\n        <span style='font-size: 1em;'> (alpha 0.7.1)</span>\n    </p>\n    <form action=\"javascript:void(0);\" onsubmit=\"()=>{return false;}\">\n    <label for='username'>Username:</label><br>\n    <input type='text' id='username' name='username' autocomplete=\"username\" placeholder='Your matrix id...'><br>\n    <label for='password'>Password:</label><br>\n    <input type='password' id='password' name='password' autocomplete=\"current-password\" placeholder='your password...'><br>\n    <button id='login-submit' class='submit'>Log in</button>\n    </form>\n    <label for='server'>Server:</label><br>\n    <input type='text' id='server-url' name='server' placeholder='Server url'><br>\n</div>\n";class S extends HTMLElement{constructor(){super()}checkUsername(t){if(new RegExp("@[a-zA-Z0-9_.+-]+\\:[a-zA-Z0-9-]+\\.[a-zA-Z0-9-.]+$").test(t)){let e=t.split(":")[1];return A("Getting homeserver Information for domain "+e),E.AutoDiscovery.findClientConfig(e).then((t=>{O();let e=t["m.homeserver"].base_url;e&&(this.shadowRoot.querySelector("#server-url").value=e)})),!0}return!1}hide(){this.shadowRoot.querySelector("#login-container").style.display="none"}loginClicked(){let t=this.shadowRoot.querySelector("#server-url").value,e=this.shadowRoot.querySelector("#username").value,o=this.shadowRoot.querySelector("#password").value;console.log("username to check: ",e),function(t){return console.log("pwd to check: ",t),t.length>1}(o)&&this.checkUsername(e)&&function(t){return t.length>5}(t)?appData.matrixClient.login(e,o,t,(()=>{this.hide()})):A("username or password dont have the correct format")}connectedCallback(){this.attachShadow({mode:"open"});let t=T.content;t.getElementById("login-submit").onclick=t=>{this.loginClicked()},t.getElementById("username").onchange=t=>{this.checkUsername(t.target.value)},t.getElementById("password").addEventListener("keypress",(function(t){"Enter"===t.key&&(t.preventDefault(),document.getElementById("login-submit").click())})),this.shadowRoot.appendChild(t)}}function L(){let t=appData.matrixClient.updateRoomTree(),e=document.getElementById("leftbar-body");e.innerHTML="";for(let o of Object.keys(t.notebooks)){let n=appData.matrixClient.client.getRoom(o);e.appendChild(j(n.name,t.notebooks[o]))}for(let o of t.whiteboards)e.appendChild(M(o,"#eee"))}function j(t,e){let o=document.createElement("div"),n=document.createElement("div"),a=document.createElement("div");n.innerHTML=t,n.classList.add("notebook-header");let i=Color.random().toCSS();function r(t){let e=0;for(let o of t.children)e+=o.getBoundingClientRect().height;return e}n.style.borderLeftColor=i,n.onclick=function(t){""==a.style.height&&(a.style.height=r(a)),0!=a.getBoundingClientRect().height?a.style.height=0:a.style.height=r(a)},o.appendChild(n);for(let t of e)a.appendChild(M(t,i));return a.classList.add("notebook-list"),o.appendChild(a),o}function M(t,e){let o=document.createElement("button"),n=appData.matrixClient.client.getRoom(t);return o.onclick=function(e){console.log(e),async function(t,e=-1,o=!0){let n=appData.drawingCanvas;console.log(n),n.clear(),n.resetOffset(),n.resetZoom(),n.setZoom(.5),A("switching Room to: "+appData.matrixClient.currentRoomId),console.log("switching Room to: "+appData.matrixClient.currentRoomId),document.getElementById("leftbar").classList.remove("no-room-selected"),appData.objectStore.addRoom(t),appData.matrixClient.currentRoomId=t;let a=e;-1==e&&(a=0==Object.keys(appData.objectStore.all()).length?300:0);let i=appData.matrixClient.client.getRoom(t),r=i.currentState.events.get("p.whiteboard.settings");r.has("colorpalette")&&SetColorPalette(r.get("colorpalette")),A("load room history");const s={year:"numeric",month:"numeric",day:"numeric",hour:"numeric"};let l=!0,c=new Date,d=new Date,p=new Date(i.currentState.getStateEvents("m.room.create","").event.origin_server_ts),h=0;for(;l;){let t=1-(c-p)/(d-p),e=await appData.matrixClient.scrollback(appData.matrixClient.currentRoomId,a,"Loaded: "+Math.floor(100*t)+"% (elements: "+h+")</br> <span style='font-size:10px'>to Date: "+c.toLocaleDateString("de-DE",s)+"  Target: "+p.toLocaleDateString("de-DE",s)+"</span>");if(n.updateDisplay_DEPRECATED(),c=new Date(e.timeline[0].event.origin_server_ts),h+=a,l=i.oldState.paginationToken,!o)break}n.reload(),n.updateDisplay_DEPRECATED()}(t)},o.classList.add("room-button"),o.style.borderLeftColor=e,o.innerHTML=n.name+"<br><span style='font-size:0.5em;color:#000'>"+n.roomId+"</span>",o}async function F(){let t=appData.matrixClient.client.getVisibleRooms(),e=document.getElementById("add-room-list");e.innerHTML="";for(let a of t){if(console.log(Array.from(a.currentState.events.keys())),a.currentState.events.has("m.space.child")||a.currentState.events.has("p.whiteboard.settings"))continue;let t=a.roomId;var o=document.createElement("div");o.onclick=async function(e){console.log(e),e.currentTarget.style.backgroundColor="#5e5",await makeWhiteboardFromRoom(t),F(),L(),actions.hideAddRoomMenu()},o.classList.add("room-button");var n=document.createElement("p");n.innerText=a.name,o.appendChild(n),e.insertBefore(o,e.firstChild)}}function A(t){document.getElementById("loading").style.display="block",document.getElementById("loading-span").innerHTML=t}function O(){document.getElementById("loading").style.display="none"}customElements.get("login-container")||customElements.define("login-container",S),window.appData={matrixClient:new class{constructor(){this.client=null,this.currentRoomId=null}updateRoomTree(){let t=new R,e=Date.now();console.log("startGettingVisibleRooms");let o=this.client.getRooms();console.log("got all visible rooms"+(Date.now()-e));let n=o.filter((t=>t.currentState.events.has("m.space.child")));for(let e in o){let a=o[e];if(console.log(Array.from(a.currentState.events.keys())),!a.currentState.events.has("p.whiteboard.settings"))continue;let i=n.find((t=>t.currentState.events.get("m.space.child").has(a.roomId)));i?(i.roomId in t.notebooks?t.notebooks[i.roomId].push(a.roomId):t.notebooks[i.roomId]=[a.roomId],console.log("whiteboard is in space!: ",i)):t.whiteboards.push(a.roomId)}return t}async createWhiteboard(t,e){let o={visibility:t,invite:[],name:""==e?"unnamed Whiteboard":e};A("Creating whiteboard with Name: "+e);let n=await appData.matrixClient.client.createRoom(o);return O(),appData.matrixClient.makeWhitebaordFromRoom.bind(appData.matrixClient),appData.matrixClient.makeWhitebaordFromRoom(n.room_id)}async makeWhitebaordFromRoom(t){let e=appData.matrixClient.client,o=await e.sendStateEvent(t,"p.whiteboard.settings",{},"");return A("make Room "+e.getRoom(t).name+"a whiteboard"),new Promise((function(t,n){let a=function(n,i,r){n.event.event_id==o.event_id&&(e.removeListener("RoomState.events",a),t(),O())};e.on("RoomState.events",a)}))}async login(t,e,o,n){A("login with: "+t+" on server: "+o),this.client=E.createClient({baseUrl:o}),appData.matrixClient=this,window.actions.createWhiteboard=this.createWhiteboard,window.actions.scrollback=this.scrollback,this.setupClientConnections();let a=await this.client.loginWithPassword(t,e,(function(t){t instanceof Error?A(t.message):n()}));console.log(a),document.getElementById("userIdLabel").innerHTML=a.user_id,A("start client"),await this.client.startClient({initialSyncLimit:0,lazyLoadMembers:!0}),A("initial sync")}setupClientConnections(){this.client.on("sync",(function(t,e,o){switch(t){case"ERROR":case"SYNCING":break;case"PREPARED":L(),A("Select a whiteboard or create a new one")}})),this.client.on("Room.localEchoUpdated",(function(t,e,o,n){if("p.whiteboard.object"===t.getType()&&"sent"===t.status){let e=project.getItem({class:"Path",match:function(t){return t.data.id==o}});e&&(e.data.id=t.event.event_id),appData.objectStore.add(t.event)}})),this.client.on("Room.timeline",(function(t,e,o){t.isRedacted()?console.log("skipped redacted evpped redacted event"):("p.whiteboard.object"==t.getType()&&(appData.drawingCanvas.drawEvent(t.event,Date.now()-t.getDate().getTime()<2e5),null==t.status&&appData.objectStore.add(t.event)),"m.room.redaction"==t.getType()&&appData.objectStore.redactById(t.event.redacts,t.event.room_id),t.getType())}))}scrollback(t,e=200,o=null){console.log("load scrollback for: "+t),console.log("load scrollback with element count: "+e),A(o||"load "+e+" elements from message history");let n=this.client,a=this.currentRoomId;return new Promise((function(o,i){0==e&&(O(),o(n.getRoom(a))),n.scrollback(n.getRoom(t),e).then((t=>{console.log("scrollback loaded"),O(),o(t)}))}))}},objectStore:new class{constructor(){this.data={exampleroom:{redacted:new Set,all:[],allDict:{},user:[],chunk:[]}}}currentRoom(){return this.data[appData.matrixClient.currentRoomId]}hasRoom(t){return t in this.data}addRoom(t){this.hasRoom(t)?console.log("room already exists"):(console.log("add room "+t+"to store"),this.data[t]={redacted:new Set,all:[],allDict:{},user:{},chunk:[]})}add(t){!t.room_id in this.data&&this.addRoom(t.room_id),this.data[t.room_id].allDict[t.event_id]=t}allSorted(){if(appData.matrixClient.currentRoomId in this.data){let t=Date.now(),e=this.currentRoom().allDict,o=Object.keys(e).map((t=>e[t]));return o.sort((function(t,e){return t.origin_server_ts-e.origin_server_ts})),console.log("sorted all events: ",Date.now()-t,"ms"),o}return[]}all(){return appData.matrixClient.currentRoomId in this.data?this.currentRoom().allDict:{}}getById(t){return Object.values(this.all()).find((e=>e.event_id==t))}redactById(t,e,o=!0){this.hasRoom(e)||this.addRoom(e);let n=this.data[e];if(o)if(t in n.allDict){delete n.allDict[t];let e=paper.project.getItem({class:"Path",match:function(e){return e.data.id==t}});e?e.remove():console.log("could not find item for id: ",t)}else console.log("unecassary redact called for id: ",t)}},drawingCanvas:new l},window.onload=function(){var t,e;appData.drawingCanvas.init(),t=document.getElementById(appData.drawingCanvas.css_id),(e=t).onpointerdown=function(t){console.log("onpointerdown");let e=appData.drawingCanvas.getTransformedPointer(t.offsetX,t.offsetY);"touch"==t.pointerType?(0==D.length?y.tooldown(e.x,e.y,t.pressure):(y.toolcancel(),_=appData.drawingCanvas.getZoom()),k.push(t),D.push(t)):y.tooldown(e.x,e.y,t.pressure)},e.onpointermove=function(t){if(1==t.buttons&&("mouse"==t.pointerType||"pen"==t.pointerType)||"touch"==t.pointerType&&D.length<2){let e=appData.drawingCanvas.getTransformedPointer(t.offsetX,t.offsetY);y.toolmove(e.x,e.y,t.pressure)}else if(4!=t.buttons||"mouse"!=t.pointerType&&"pen"!=t.pointerType){if(2==D.length&&"touch"==t.pointerType){let e=D.findIndex((e=>t.pointerId===e.pointerId));D[e]=t,function(){let t=appData.drawingCanvas,e=t.canvas.getBoundingClientRect().x,o=t.canvas.getBoundingClientRect().y,n=t.getZoom(),i=t.getTransformedPointer(k[0].clientX-e,k[0].clientY-o),r=t.getTransformedPointer(k[1].clientX-e,k[1].clientY-o),s=t.getTransformedPointer(D[0].clientX-e,D[0].clientY-o),l=t.getTransformedPointer(D[1].clientX-e,D[1].clientY-o);var c=a(i,r),d=a(s,l),p=s.add(l).multiply(.5),h=i.add(r).multiply(.5),m=a(p,h)*n,u=Math.abs(c-d)*n;if(!(u<70&&m<40)){if(""==I&&(I=u>m?"pinch":"pan"),"pinch"==I){var v=d/c;t.setZoom(_*v,h)}if("pan"==I){var g=h.subtract(p),w=new paper.Point(P.x-g.x,P.y-g.y);P=g,t.offset(w)}}}()}}else{let e=new paper.Point(t.movementX,t.movementY);appData.drawingCanvas.offset(e.divide(appData.drawingCanvas.getZoom()))}y.toolpreviewmove(appData.drawingCanvas.getTransformedPointer(t.offsetX,t.offsetY))},e.onpointerup=function(t){console.log("onpointerup");let e=appData.drawingCanvas.getTransformedPointer(t.offsetX,t.offsetY);"touch"==t.pointerType?(D=D.filter((e=>{e.pointerId,t.pointerId})),k=k.filter((e=>{e.pointerId,t.pointerId})),P=new DOMPoint(0,0),I="",_=0,y.tool_canceled||y.toolup(e.x,e.y,t.pressure)):y.toolup(e.x,e.y,t.pressure)},e.onwheel=function(t){if(t.preventDefault(),t.ctrlKey)e=t.offsetX,o=t.offsetY,n=1+t.wheelDeltaY,appData.drawingCanvas.zoom(1+.004*n,new paper.Point(e,o));else{let e=.5,o=new paper.Point(t.wheelDeltaX*e,t.wheelDeltaY*e);appData.drawingCanvas.offset(o.divide(appData.drawingCanvas.getZoom()))}var e,o,n},e.onpointerover=C,e.onpointerenter=b,e.addEventListener("touchstart",(t=>{t.preventDefault()}),{passive:!1}),e.addEventListener("gesturestart",(t=>{t.preventDefault()}),{passive:!1}),u=new g,u.selectColor([1,0]),function(){document.getElementById("tool-wheel");let t=document.getElementById("color-picker-canvas").getBoundingClientRect(),e=new x.Point(t.width,t.height);e=e.multiply(.5);let o=document.querySelectorAll(".tool-elements"),n=document.getElementById("settings-button");n.style.left=e.x,n.style.bottom=e.y;let a=e.x+15,i=-Math.PI/10;for(let t=0;t<o.length;t++){console.log(o[t].tagName);let n=o[t],r=t*Math.PI/7+i,s=new x.Point(Math.sin(r)*a,Math.cos(r)*a);n.style.left=e.x+s.x,n.style.bottom=e.y+s.y}for(let t of o)t.id in f&&(t.onclick=function(e){for(let t of o)t.classList.remove("active");var n;y.deactivate(),n=t.id,(y=f[n]).activate(),t.classList.add("active")},y==f[t.id]&&t.classList.add("active"))}(),function(){function t(){let t=document.querySelectorAll("#line-type-selector-button div");for(let e=0;e<4;e++)t[e].style.display=e==h?"block":"none"}document.getElementById("line-type-selector-button").onclick=function(e){h+=1,h%=4,t()},t()}(),window.actions.updateRoomList=()=>{L()},window.actions.updateAddRoomList=F}}},t=>{t(t.s=784)}]);
//# sourceMappingURL=main.bundle.js.map