"use strict";(self.webpackChunktheboard_matrix=self.webpackChunktheboard_matrix||[]).push([[179],{7303:(e,t,o)=>{function n(e){let t=e.clone(),o=t.bounds;t.position=t.position.subtract(o.topLeft);let n="";for(let e of t.segments)n+=e.point.x.toFixed(3)+" "+e.point.y.toFixed(3)+" "+e.handleIn.x.toFixed(3)+" "+e.handleIn.y.toFixed(3)+" "+e.handleOut.x.toFixed(3)+" "+e.handleOut.y.toFixed(3)+" ";return t.remove(),[o.topLeft,o.size,n.trim()]}function a(e,t){return Math.sqrt((e.x-t.x)**2+(e.y-t.y)**2)}function i(e){let t=(e||"0 0").split(" ");return new paper.Point(parseFloat(t[0]),parseFloat(t[1]))}function r(e,t){const o=Math.round(255*Math.min(Math.max(t||1,0),1)).toString(16).toUpperCase();return 7==e.length?e+o:9==e.length?(e[7]=o[0],e[8]=o[1],e):void 0}function s(e,t,o=!0){let n=appData.drawingCanvas;if("p.path"==e.content.objtype)if(1!=e.content.version&&"version"in e.content){if(2==e.content.version){let a=function(e,t){let o=e.split(" ");o=o.filter((e=>""!=e));var n=t.split(" "),a=[];for(let e=0;e<o.length;e+=6){let t=new paper.Segment(new paper.Point(parseFloat(o[e+0])+parseFloat(n[0]),parseFloat(o[e+1])+parseFloat(n[1])),new paper.Point(parseFloat(o[e+2]),parseFloat(o[e+3])),new paper.Point(parseFloat(o[e+4]),parseFloat(o[e+5])));a.push(t)}return a}(e.content.path,e.content.objpos),i=parseFloat(e.content.strokeWidth),r="closed"in e.content&&e.content.closed,s="objcolor"in e.content?e.content.objcolor:"#000",l="objFillColor"in e.content?e.content.objFillColor:"#00000000";t?(n.updateDisplay_DEPRECATED(!0),n.asyncAddPathV2(a,s,l,i,r,e.event_id)):(n.addPathV2(a,s,l,i,r,e.event_id),o&&n.updateDisplay_DEPRECATED(!0))}}else{let a=function(e,t){let o=e.split(" ");var n=t.split(" "),a=[];for(let e=0;e<o.length;e+=4){let t=parseFloat(o[e]),i=parseFloat(o[e+1])+parseFloat(n[0]),r=parseFloat(o[e+2])+parseFloat(n[1]),s=parseFloat(o[e+3]);a.push([t,i,r,s])}return a}(e.content.path,e.content.objpos),r=i(e.content.objpos),s=i(e.content.objsize),l="objcolor"in e.content?e.content.objcolor:"#000";t?n.asyncAddPathV1([r.x,r.y],a,l):(n.drawBoundingBox([[r.x,r.y],s]),n.addPathV1(a,l,[[r.x,r.y],s],e.event_id),o&&n.updateDisplay_DEPRECATED(!0))}}o.d(t,{Zk:()=>W,QP:()=>O,rB:()=>F,HS:()=>j});const l=o(3267);class c{constructor(){this.css_id="paper-canvas",this.displayPaths=[],this.toolLayer=null,this.drawLayer=null,this.canvas=null}activateToolLayer(){this.toolLayer.activate()}activateDrawLayer(){this.drawLayer.activate()}init(){this.canvas=document.getElementById("paper-canvas"),l.setup(this.canvas),l.install(window),this.drawLayer=l.project.activeLayer,this.toolLayer=new l.Layer}offset(e){l.view.center=l.view.center.subtract(e)}resetOffset(){this.setOffset(new l.Point(0,0))}setOffset(e){l.view.center=e}getZoom(){return l.view.zoom}zoom(e,t){if(null===t)l.view.scale(e);else{var o=l.view.viewToProject(t);l.view.scale(e,o)}}setZoom(e,t=l.view.center){var o=l.view.center,n=l.view.viewToProject(t);l.view.center=n,l.view.zoom,l.view.zoom=e,l.view.center=o}resetZoom(){this.setZoom(1)}asyncAddPathV1(){console.log("WAIT WHAT???")}asyncAddPathV2(e,t,o,n,a=!1,i=""){let r=this.addPathV2(e,t,o,n,a,i),s=0;s=r.length,r.dashArray=[s,s],r.tween({dashOffset:s},{dashOffset:0},2*s).then((()=>{r.dashArray=[]}))}addPathV2(e,t,o,n,a=!1,i=""){var r=new l.Path(e);return r.strokeColor=t,r.fillColor=o,r.strokeWidth=n,r.strokeCap="round",r.closed=a,""!=i&&(r.data.id=i),r}addPathV1(e,t,[o,n],a=""){var i=new l.Path;i.strokeColor=t,i.strokeWidth=2,i.strokeCap="round",""!=a&&(i.data.id=a),i.moveTo(new l.Point(e[0][1],e[0][2]));for(let t=1;t<e.length;t++)i.lineTo(new l.Point(e[t][1],e[t][2]))}updateDisplay_DEPRECATED(){null!==this.dispPath&&(this.displayPaths.push(this.dispPath),this.dispPath=null)}clearDisplayPaths(){this.displayPaths.forEach((e=>{e.remove()}))}clear(){var e=0;for(let t of l.project.layers)t!==this.toolLayer&&(e+=t.removeChildren().length);console.log("removed ",e," items")}drawBoundingBox(e){}reload(e=!1){this.clear();var t=Date.now();console.log("!! Paper Canvas redraw START"),appData.objectStore.allSorted().forEach((t=>{"p.whiteboard.object"==t.type&&s(t,e,e)})),console.log("!! Paper Canvas redraw DONE in",Date.now()-t)}getTransformedPointer(e,t){return l.view.viewToProject(new l.Point(e,t))}}function d(e,t,o,n,a,i,r,s,l,c){console.log("send random path: ...");const d={version:c,svg:"none",objtype:"p.path",objpos:i[0]+" "+i[1],objsize:r[0]+" "+r[1],objcolor:""==n?"#"+["F55","5F5","55F"][Math.floor(3*Math.random())]:n,objFillColor:""==a?"#"+["F55","5F5","55F"][Math.floor(3*Math.random())]:a,path:o,strokeWidth:s,closed:l};e.sendEvent(t,"p.whiteboard.object",d,"",((e,t)=>{console.log(e)}))}function p(){let e=null,t=appData.matrixClient.client.getUserId(),o=appData.objectStore.allSorted();for(let n=o.length-1;n>=0;n--){let a=o[n];if(console.log("looping through events to find the one to redact"),"p.whiteboard.object"==a.type&&a.sender==t){e=a;break}}return e}function h(e,t){appData.matrixClient.client.sendEvent(appData.matrixClient.currentRoomId,"p.whiteboard.object",t,"",((e,t)=>{console.log(e)})),appData.matrixClient.client.redactEvent(appData.matrixClient.currentRoomId,e).then((e=>{console.log("redacted for replace ",e)}))}window.actions={redactLastAction:function(){let e="",t=appData.matrixClient.currentRoomId,o=appData.matrixClient.client.getUserId(),n=objectStore.allSorted();for(let t=n.length-1;""===e&&t>=0;t--){let a=n[t];if(console.log("looping through events to find the one to redact"),"p.whiteboard.object"==a.type&&a.sender==o){e=a.event_id;break}}client.redactEvent(t,e).then((e=>{console.log("redacted: ",e)}))},formSubmit:function(e){return e.preventDefault(),console.log("onsub"),!1},replaceLastEvent:function(){h(p().event_id,{version:2,svg:"none",objtype:"p.path",objpos:"100 100",objcolor:"#000",closed:!0,objFillColor:"#ff000030",strokeWidth:3,path:"0 0 0 0 0 0 0 100 0 0 0 0 100 100 0 0 0 0 100 0 0 0 0 0"})},moveLastEvent:function(){let e=p(),t=i(e.content.objpos).add(new paper.Point(100,0));e.content.objpos=t.x+" "+t.y,h(e.event_id,e.content)},showAddRoomMenu:function(){F(),document.getElementById("add-room-container").style.display="block"},hideAddRoomMenu:function(){document.getElementById("add-room-container").style.display="none"},showSettingsMenu:function(){let e=document.getElementById("settings-container"),t=document.getElementById("room-menu-room-id"),o=appData.matrixClient.client.getRoom(appData.matrixClient.currentRoomId);t.innerHTML=o.roomId,e.style.display="block"},hideSettingsMenu:function(){document.getElementById("settings-container").style.display="none"}};var m=1;function u(){return m}let v;function g(){return v.getColor().toCSS(!0)}class w{constructor(){this.colors=["#999","#8ae234","#ef2929","#fcaf3e","#729fcf","#ad7fa8"],this.darkColors=this.colors.map((e=>new l.Color(e).multiply(.7))),this.darkColors[0]="black",this.outline=null,this.colorPaths=[[],[]],this.selectedColor=[0,0],this.COLOR_PICKER_BORDER=20,this.innerCircle=.35,this.middleCircle=.7,this.project=new l.Project("color-picker-canvas"),this.redraw()}redraw(){this.project.activate(),document.getElementById("color-picker-canvas");let e=l.view.size,t=new l.Point(e.divide(2)),o=e.width/2-this.COLOR_PICKER_BORDER,n=new l.Path.Circle(t,o);n.shadowBlur=this.COLOR_PICKER_BORDER,n.shadowColor="grey",n.fillColor="white",this.colorPaths[0]=this.create_segment_ring(this.colors,t,o*this.middleCircle-1,o,0),this.colorPaths[1]=this.create_segment_ring(this.darkColors,t,o*this.innerCircle,o*this.middleCircle,1);let a=new l.Path.Circle(t,this.innerCircle*o);a.shadowBlur=this.COLOR_PICKER_BORDER,a.shadowColor="#444",a.fillColor="white",l.projects[0].activate()}setColorPalette(e){this.colors=["#999"].concat(e),this.darkColors=this.colors.map((e=>new l.Color(e).multiply(.7))),this.darkColors[0]="black",this.redraw()}create_segment_ring(e,t,o,n,a){let i=e.length,r=Math.PI/i,s=[];for(let l=0;l<i;l++){let c=2*Math.PI/i*l-r,d=2*Math.PI/i*(l+1)-r,p=this.create_segment(t,o,n,c,d);p.fillColor=e[l],p.onMouseDown=function(e){v.selectColor([a,l])},s.push(p)}return s}create_segment(e,t,o,n,a){function i(e,t,o){let n=Math.sin(e)*o,a=-Math.cos(e)*o;return t.add(new l.Point(n,a))}let r=new l.Path,s=(n+a)/2;return r.moveTo(i(n,e,o)),r.arcTo(i(s,e,o),i(a,e,o)),r.lineTo(i(a,e,t)),r.arcTo(i(s,e,t),i(n,e,t)),r.closePath(),r}selectColor(e){this.selectedColor=e;let t=this.colorPaths[e[0]][e[1]];null!==this.outline&&this.outline.remove(),this.outline=t.clone(),this.outline.fillColor="#FFFFFF00",this.outline.strokeWidth=4,this.outline.bringToFront(),this.outline.strokeColor="white"}getColor(){return this.colorPaths[this.selectedColor[0]][this.selectedColor[1]].fillColor}}class f{constructor(e=!1){this.isMarker=e,this.mouse_path=[],this.mouse_path_last_time=Date.now(),this.last_pos=[],this.tool_canceled=!1,this.strokeWidthOptions=[1,2,4,8],this.previewItem=null,this.previewPaths=[],this.previewPathTween=null}getStrokeWidth(){return this.strokeWidthOptions[u()]*(this.isMarker?10:1)}getStrokeColor(){return this.isMarker?r(g(),.1):g()}tooldown(e,t,o){this.tool_canceled=!1,this.mouse_path_start_time=Date.now(),this.last_pos=[0,e,t,o],this.mouse_path=[[0,e,t,4*o]],appData.drawingCanvas.activateToolLayer();for(let e of this.previewPaths)e.visible||e.remove();this.previewPaths.filter((e=>{e.visible}));let n=new Path;this.previewPaths.push(n);let a=new Color(this.getStrokeColor());a.alpha=.6*a.alpha,n.strokeColor=a,n.strokeWidth=this.getStrokeWidth(),n.strokeCap="round",n.moveTo(new Point(e,t)),appData.drawingCanvas.activateDrawLayer(),console.log("tooldown")}toolmove(e,t,o){console.log("toolmove");let n=e,a=t,i=Math.min(80,Date.now()-this.mouse_path_last_time);this.mouse_path_last_time=Date.now();let r=[i,n,a,2+Math.min(3,Math.max(0,1))],s=(this.last_pos[1],this.last_pos[2],new Point(r[1],r[2]));this.mouse_path.push(r),this.previewPaths[this.previewPaths.length-1].lineTo(s),this.previewPaths[this.previewPaths.length-1].smooth(),this.last_pos=r}toolpreviewmove(e){null===this.previewItem&&(appData.drawingCanvas.activateToolLayer(),this.previewItem=new Path.Circle(new Point(0,0),.5),this.previewItem.applyMatrix=!1,appData.drawingCanvas.activateDrawLayer()),this.previewItem.scaling=new Point(this.getStrokeWidth(),this.getStrokeWidth()),this.previewItem.fillColor=this.getStrokeColor(),this.previewItem.position=e}toolup(e,t){if(!this.tool_canceled){if(appData.objectStore.hasRoom(appData.matrixClient.currentRoomId)){let e,t,[o,a,i]=function(e){let t=[Number.MAX_VALUE,Number.MAX_VALUE],o=[-Number.MAX_VALUE,-Number.MAX_VALUE];for(let n of e)t[0]=Math.min(t[0],n[1]),t[1]=Math.min(t[1],n[2]),o[0]=Math.max(o[0],n[1]),o[1]=Math.max(o[1],n[2]);let n=e.map((e=>[e[0],e[1]-t[0],e[2]-t[1],e[3]])),a=o[0]-t[0],i=o[1]-t[1];return[n,t,[a,i]]}(this.mouse_path);if(appData.drawingCanvas instanceof c){let a=new Path(o.map((e=>[e[1],e[2]])));a.simplify(1/appData.drawingCanvas.getZoom()),e=n(a)[2],a.remove(),t=2}d(appData.matrixClient.client,appData.matrixClient.currentRoomId,e,this.getStrokeColor(),"#00000000",a,i,this.getStrokeWidth(),!1,t)}else console.log("NO ROOM SELECTED TO DRAW IN!"),appData.drawingCanvas.updateDisplay_DEPRECATED();this.toolcancel()}}toolcancel(){console.log("CANCEL"),this.mouse_path=[],this.mouse_path_last_time=Date.now(),this.last_pos=[],this.tool_canceled=!0;let e=this.previewPaths[this.previewPaths.length-1],t=e.length;e.dashArray=[t,t],e.tween({dashOffset:0},{dashOffset:-t},2*t).then((t=>{e.visible=!1}))}activate(){this.previewItem&&(this.previewItem.visible=!0)}deactivate(){this.previewItem&&(this.previewItem.visible=!1)}}var y={"tool-type-pen":new f,"tool-type-eraser":new class{constructor(){this.removedElementsArray,this.tool_canceled=!1,this.idsToDelete=[],this.strokeWidthOptions=[5,10,20,40],this.previewItem=null}getStrokeWidth(){return this.strokeWidthOptions[u()]}tooldown(e,t,o){this.tool_canceled=!1,this.addItemsFromPoint(new paper.Point(e,t)),console.log("tooldown")}toolmove(e,t,o){console.log("toolmove"),this.addItemsFromPoint(new paper.Point(e,t))}addItemsFromPoint(e){for(var t={stroke:!0,tolerance:this.getStrokeWidth(),match:function(e){return!("markedForDeletion"in e.item.data)&&"id"in e.item.data}},o=paper.project.hitTest(e,t),n=0;o&&n<10;)o&&(console.log("hitResult",o),appData.objectStore.getById(o.item.data.id).sender==appData.matrixClient.client.getUserId()&&(o.item.opacity=.5,o.item.data.markedForDeletion=!0,this.idsToDelete.push(o.item.data.id),o=paper.project.hitTest(e,t)),n++)}toolup(e,t){if(!this.tool_canceled){this.toolcancel(),console.log(this.idsToDelete);for(let e of this.idsToDelete)console.log(e),appData.matrixClient.client.redactEvent(appData.matrixClient.currentRoomId,e).then((e=>{console.log("redacted (eraser): ",e)})),this.idsToDelete=this.idsToDelete.filter((t=>t==e));this.idsToDelete=[]}}toolcancel(){console.log("CANCEL"),this.tool_canceled=!0}toolpreviewmove(e){if(null===this.previewItem&&(appData.drawingCanvas.activateToolLayer(),this.previewItem=new paper.Path.Circle(new paper.Point(0,0),1),this.previewItem.fillColor="#00000000",this.previewItem.strokeWidth=1,this.previewItem.strokeColor="#999",this.previewItem.dashArray=[3,3],this.previewItem.strokeCap="round",appData.drawingCanvas.activateDrawLayer()),this.previewItem.bounds.size.width!=2*this.getStrokeWidth()){let e=2*this.getStrokeWidth()/this.previewItem.bounds.size.width;this.previewItem.scaling=new paper.Point(e,e)}this.previewItem.position=e}activate(){this.previewItem&&(this.previewItem.visible=!0)}deactivate(){this.previewItem.visible=!1}},"tool-type-marker":new f(!0),"tool-type-line":new class{constructor(){this.canvas_line=null,this.tool_canceled=!0,this.strokeWidthOptions=[1,2,4,8]}getStrokeWidth(){return this.strokeWidthOptions[u()]}tooldown(e,t,o){this.tool_canceled=!1;let n=new paper.Point(e,t);this.canvas_line=new paper.Path([n,n]);let a=r(g(),.3);this.canvas_line.strokeColor=a,this.canvas_line.strokeWidth=this.getStrokeWidth(),this.canvas_line.strokeCap="round",console.log("tooldown")}toolmove(e,t,o){console.log("toolmove"),this.canvas_line.lastSegment.point=new paper.Point(e,t)}toolup(e,t){if(!this.tool_canceled){if(appData.objectStore.hasRoom(appData.matrixClient.currentRoomId)){let[e,t,o]=n(this.canvas_line),a=2;d(appData.matrixClient.client,appData.matrixClient.currentRoomId,o,g(),"#00000000",[e.x,e.y],[t.width,t.height],this.getStrokeWidth(),!1,a)}else console.log("NO ROOM SELECTED TO DRAW IN!"),appData.drawingCanvas.updateDisplay_DEPRECATED();this.toolcancel()}}toolcancel(){console.log("CANCEL"),null!==this.canvas_line&&this.canvas_line.remove(),this.canvas_line=null,this.tool_canceled=!0}toolpreviewmove(e){}activate(){}deactivate(){}},"tool-type-square":new class{constructor(){this.canvas_rect=null,this.strokeWidthOptions=[1,2,4,8]}getStrokeWidth(){return this.strokeWidthOptions[u()]}tooldown(e,t,o){this.tool_canceled=!1;let n=new paper.Point(e,t);appData.drawingCanvas.activateToolLayer(),this.canvas_rect=new paper.Path.Rectangle(n,n);let a=r(g(),.3);this.canvas_rect.strokeColor=a,this.canvas_rect.strokeWidth=this.getStrokeWidth(),this.canvas_rect.strokeCap="round",appData.drawingCanvas.activateDrawLayer(),console.log("tooldown")}toolmove(e,t,o){console.log("toolmove"),this.canvas_rect.segments[1].point.x=e,this.canvas_rect.segments[2].point.x=e,this.canvas_rect.segments[2].point.y=t,this.canvas_rect.segments[3].point.y=t}toolup(e,t){if(!this.tool_canceled){if(appData.objectStore.hasRoom(appData.matrixClient.currentRoomId)){let[e,t,o]=n(this.canvas_rect),a=2;d(appData.matrixClient.client,appData.matrixClient.currentRoomId,o,g(),r(g(),.08),[e.x,e.y],[t.width,t.height],this.getStrokeWidth(),!0,a)}else console.log("NO ROOM SELECTED TO DRAW IN!"),appData.drawingCanvas.updateDisplay_DEPRECATED();this.toolcancel()}}toolcancel(){console.log("CANCEL"),null!==this.canvas_rect&&(this.canvas_rect.remove(),this.canvas_rect=null,this.tool_canceled=!0)}toolpreviewmove(e){}activate(){}deactivate(){}},"tool-type-ellipse":null,"tool-type-text":null,"tool-type-line-width":null},C=y["tool-type-pen"];function b(e){}function D(e){}var k=[],_=[],P=0,I=new DOMPoint(0,0);P=0,I=new DOMPoint(0,0);var R="",E=o(8743);class x{constructor(){this.notebooks={},this.whiteboards=[]}clear(){this.notebooks={},this.whiteboards=[]}}var T=o(3267);const S=document.createElement("template");S.innerHTML="\n<link href=\"style.css\" rel=\"stylesheet\" type=\"text/css\">\n<style>\n    span {\n        font-size: 3em;\n        white-space: pre;\n        font-weight: 100;\n    }\n    input {\n        width: 100%;\n        padding: 12px 20px;\n        margin: 8px 0;\n        display: inline-block;\n        border: 1px solid #ccc;\n        border-radius: 4px;\n        box-sizing: border-box;\n    }\n    button.submit {\n        width: 100%;\n        background-color: #FFAF50;\n        background-color: #4CAF50;\n        color: white;\n        padding: 14px 20px;\n        margin: 8px 0;\n        border: none;\n        border-radius: 4px;\n        cursor: pointer;\n    }\n</style>\n<div class='center-container' id='login-container'>\n    <p>\n        <span>The Board</span>\n        <span style='font-size: 1em;'> (alpha 0.7.1)</span>\n    </p>\n    <form action=\"javascript:void(0);\" onsubmit=\"()=>{return false;}\">\n    <label for='username'>Username:</label><br>\n    <input type='text' id='username' name='username' autocomplete=\"username\" placeholder='Your matrix id...'><br>\n    <label for='password'>Password:</label><br>\n    <input type='password' id='password' name='password' autocomplete=\"current-password\" placeholder='your password...'><br>\n    <label for='server'>Server:</label><br>\n    <input type='text' id='server-url' name='server' placeholder='Server url'><br>\n    <button id='login-submit' class='submit'>Log in</button>\n    </form>\n</div>\n";class L extends HTMLElement{constructor(){super()}checkUsername(e){if(new RegExp("@[a-zA-Z0-9_.+-]+\\:[a-zA-Z0-9-]+\\.[a-zA-Z0-9-.]+$").test(e)){let t=e.split(":")[1];return O("Getting homeserver Information for domain "+t),E.AutoDiscovery.findClientConfig(t).then((e=>{W();let t=e["m.homeserver"].base_url;t&&(this.shadowRoot.querySelector("#server-url").value=t)})),!0}return!1}hide(){this.shadowRoot.querySelector("#login-container").style.display="none"}loginClicked(){let e=this.shadowRoot.querySelector("#server-url").value,t=this.shadowRoot.querySelector("#username").value,o=this.shadowRoot.querySelector("#password").value;console.log("username to check: ",t),function(e){return console.log("pwd to check: ",e),e.length>1}(o)&&this.checkUsername(t)&&function(e){return e.length>5}(e)?appData.matrixClient.login(t,o,e,(()=>{this.hide()})):O("username or password dont have the correct format")}connectedCallback(){this.attachShadow({mode:"open"});let e=S.content;e.getElementById("login-submit").onclick=e=>{this.loginClicked()},e.getElementById("username").onchange=e=>{this.checkUsername(e.target.value)},e.getElementById("password").addEventListener("keypress",(function(e){"Enter"===e.key&&(e.preventDefault(),document.getElementById("login-submit").click())})),this.shadowRoot.appendChild(e)}}function j(){let e=appData.matrixClient.updateRoomTree(),t=document.getElementById("leftbar-body");t.innerHTML="";for(let o of Object.keys(e.notebooks)){let n=appData.matrixClient.client.getRoom(o);t.appendChild(M(n.name,e.notebooks[o]))}for(let o of e.whiteboards)t.appendChild(A(o,"#eee"))}function M(e,t){let o=document.createElement("div"),n=document.createElement("div"),a=document.createElement("div");n.innerHTML=e,n.classList.add("notebook-header");let i=Color.random().toCSS();function r(e){let t=0;for(let o of e.children)t+=o.getBoundingClientRect().height;return t}n.style.borderLeftColor=i,n.onclick=function(e){""==a.style.height&&(a.style.height=r(a)),0!=a.getBoundingClientRect().height?a.style.height=0:a.style.height=r(a)},o.appendChild(n);for(let e of t)a.appendChild(A(e,i));return a.classList.add("notebook-list"),o.appendChild(a),o}function A(e,t){let o=document.createElement("button"),n=appData.matrixClient.client.getRoom(e);return o.onclick=function(t){console.log(t),async function(e,t=-1,o=!0){let n=appData.drawingCanvas;console.log(n),n.clear(),n.resetOffset(),n.resetZoom(),n.setZoom(.5),O("switching Room to: "+appData.matrixClient.currentRoomId),console.log("switching Room to: "+appData.matrixClient.currentRoomId),document.getElementById("leftbar").classList.remove("no-room-selected"),appData.objectStore.addRoom(e),appData.matrixClient.currentRoomId=e;let a=t;-1==t&&(a=0==Object.keys(appData.objectStore.all()).length?300:0);let i=appData.matrixClient.client.getRoom(e),r=i.currentState.events.get("p.whiteboard.settings");r.has("colorpalette")&&SetColorPalette(r.get("colorpalette")),O("load room history");const s={year:"numeric",month:"numeric",day:"numeric",hour:"numeric"};let l=!0,c=new Date,d=new Date,p=new Date(i.currentState.getStateEvents("m.room.create","").event.origin_server_ts),h=0;for(;l;){let e=1-(c-p)/(d-p),t=await appData.matrixClient.scrollback(appData.matrixClient.currentRoomId,a,"Loaded: "+Math.floor(100*e)+"% (elements: "+h+")</br> <span style='font-size:10px'>to Date: "+c.toLocaleDateString("de-DE",s)+"  Target: "+p.toLocaleDateString("de-DE",s)+"</span>");if(n.updateDisplay_DEPRECATED(),c=new Date(t.timeline[0].event.origin_server_ts),h+=a,l=i.oldState.paginationToken,!o)break}n.reload(),n.updateDisplay_DEPRECATED()}(e)},o.classList.add("room-button"),o.style.borderLeftColor=t,o.innerHTML=n.name+"<br><span style='font-size:0.5em;color:#000'>"+n.roomId+"</span>",o}async function F(){let e=appData.matrixClient.getVisibleRooms(),t=document.getElementById("add-room-list");t.innerHTML="";for(let a of e){if(console.log(Array.from(a.currentState.events.keys())),a.currentState.events.has("m.space.child")||a.currentState.events.has("p.whiteboard.settings"))continue;let e=a.roomId;var o=document.createElement("div");o.onclick=async function(t){console.log(t),t.currentTarget.style.backgroundColor="#5e5",await makeWhiteboardFromRoom(e),F(),j(),hideAddRoomMenu()},o.classList.add("room-button");var n=document.createElement("p");n.innerText=a.name,o.appendChild(n),t.insertBefore(o,t.firstChild)}}function O(e){document.getElementById("loading").style.display="block",document.getElementById("loading-span").innerHTML=e}function W(){document.getElementById("loading").style.display="none"}customElements.get("login-container")||customElements.define("login-container",L),window.appData={matrixClient:new class{constructor(){this.client=null,this.currentRoomId=null}updateRoomTree(){let e=new x,t=Date.now();console.log("startGettingVisibleRooms");let o=this.client.getRooms();console.log("got all visible rooms"+(Date.now()-t));let n=o.filter((e=>e.currentState.events.has("m.space.child")));for(let t in o){let a=o[t];if(console.log(Array.from(a.currentState.events.keys())),!a.currentState.events.has("p.whiteboard.settings"))continue;let i=n.find((e=>e.currentState.events.get("m.space.child").has(a.roomId)));i?(i.roomId in e.notebooks?e.notebooks[i.roomId].push(a.roomId):e.notebooks[i.roomId]=[a.roomId],console.log("whiteboard is in space!: ",i)):e.whiteboards.push(a.roomId)}return e}async createWhiteboard(e="private",t="unnamed Whiteboard"){let o={visibility:e,invite:[],name:""==t?"unnamed Whiteboard":t};O("Creating whiteboard with Name: "+t);let n=await this.client.createRoom(o);return W(),makeWhitebaordFromRoom(n.room_id)}async makeWhitebaordFromRoom(e){let t=await this.client.sendStateEvent(e,"p.whiteboard.settings",{},"");return O("make Room "+this.client.getRoom(e).name+"a whiteboard"),new Promise((function(e,o){let n=function(o,a,i){o.event.event_id==t.event_id&&(this.client.removeListener("RoomState.events",n),e(),W())};this.client.on("RoomState.events",n)}))}async login(e,t,o,n){O("login with: "+e+" on server: "+o),this.client=E.createClient({baseUrl:o}),appData.matrixClient=this,window.actions.createWhiteboard=this.createWhiteboard,window.actions.scrollback=this.scrollback,this.setupClientConnections();let a=await this.client.loginWithPassword(e,t,(function(e){e instanceof Error?O(e.message):n()}));console.log(a),document.getElementById("userIdLabel").innerHTML=a.user_id,O("start client"),await this.client.startClient({initialSyncLimit:0,lazyLoadMembers:!0}),O("initial sync")}setupClientConnections(){this.client.on("sync",(function(e,t,o){switch(e){case"ERROR":case"SYNCING":break;case"PREPARED":j(),O("Select a whiteboard or create a new one")}})),this.client.on("Room.localEchoUpdated",(function(e,t,o,n){if("p.whiteboard.object"===e.getType()&&"sent"===e.status){let t=project.getItem({class:"Path",match:function(e){return e.data.id==o}});t&&(t.data.id=e.event.event_id),appData.objectStore.add(e.event)}})),this.client.on("Room.timeline",(function(e,t,o){e.isRedacted()?console.log("skipped redacted evpped redacted event"):("p.whiteboard.object"==e.getType()&&(s(e.event,Date.now()-e.getDate().getTime()<2e5),null==e.status&&appData.objectStore.add(e.event)),"m.room.redaction"==e.getType()&&appData.objectStore.redactById(e.event.redacts,e.event.room_id),e.getType())}))}scrollback(e,t=200,o=null){console.log("load scrollback for: "+e),console.log("load scrollback with element count: "+t),O(o||"load "+t+" elements from message history");let n=this.client,a=this.currentRoomId;return new Promise((function(o,i){0==t&&(W(),o(n.getRoom(a))),n.scrollback(n.getRoom(e),t).then((e=>{console.log("scrollback loaded"),W(),o(e)}))}))}},objectStore:new class{constructor(){this.data={exampleroom:{redacted:new Set,all:[],allDict:{},user:[],chunk:[]}}}currentRoom(){return this.data[appData.matrixClient.currentRoomId]}hasRoom(e){return e in this.data}addRoom(e){this.hasRoom(e)?console.log("room already exists"):(console.log("add room "+e+"to store"),this.data[e]={redacted:new Set,all:[],allDict:{},user:{},chunk:[]})}add(e){!e.room_id in this.data&&this.addRoom(e.room_id),this.data[e.room_id].allDict[e.event_id]=e}allSorted(){if(appData.matrixClient.currentRoomId in this.data){let e=Date.now(),t=this.currentRoom().allDict,o=Object.keys(t).map((e=>t[e]));return o.sort((function(e,t){return e.origin_server_ts-t.origin_server_ts})),console.log("sorted all events: ",Date.now()-e,"ms"),o}return[]}all(){return appData.matrixClient.currentRoomId in this.data?this.currentRoom().allDict:{}}getById(e){return Object.values(this.all()).find((t=>t.event_id==e))}redactById(e,t,o=!0){this.hasRoom(t)||this.addRoom(t);let n=this.data[t];if(o)if(e in n.allDict){delete n.allDict[e];let t=paper.project.getItem({class:"Path",match:function(t){return t.data.id==e}});t?t.remove():console.log("could not find item for id: ",e)}else console.log("unecassary redact called for id: ",e)}},drawingCanvas:new c},window.onload=function(){var e,t;appData.drawingCanvas.init(),e=document.getElementById(appData.drawingCanvas.css_id),(t=e).onpointerdown=function(e){console.log("onpointerdown");let t=appData.drawingCanvas.getTransformedPointer(e.offsetX,e.offsetY);"touch"==e.pointerType?(0==k.length?C.tooldown(t.x,t.y,e.pressure):(C.toolcancel(),P=appData.drawingCanvas.getZoom()),_.push(e),k.push(e)):C.tooldown(t.x,t.y,e.pressure)},t.onpointermove=function(e){if(1==e.buttons&&("mouse"==e.pointerType||"pen"==e.pointerType)||"touch"==e.pointerType&&k.length<2){let t=appData.drawingCanvas.getTransformedPointer(e.offsetX,e.offsetY);C.toolmove(t.x,t.y,e.pressure)}else if(4!=e.buttons||"mouse"!=e.pointerType&&"pen"!=e.pointerType){if(2==k.length&&"touch"==e.pointerType){let t=k.findIndex((t=>e.pointerId===t.pointerId));k[t]=e,function(){let e=appData.drawingCanvas,t=e.canvas.getBoundingClientRect().x,o=e.canvas.getBoundingClientRect().y,n=e.getZoom(),i=e.getTransformedPointer(_[0].clientX-t,_[0].clientY-o),r=e.getTransformedPointer(_[1].clientX-t,_[1].clientY-o),s=e.getTransformedPointer(k[0].clientX-t,k[0].clientY-o),l=e.getTransformedPointer(k[1].clientX-t,k[1].clientY-o);var c=a(i,r),d=a(s,l),p=s.add(l).multiply(.5),h=i.add(r).multiply(.5),m=a(p,h)*n,u=Math.abs(c-d)*n;if(!(u<70&&m<40)){if(""==R&&(R=u>m?"pinch":"pan"),"pinch"==R){var v=d/c;e.setZoom(P*v,h)}if("pan"==R){var g=h.subtract(p),w=new paper.Point(I.x-g.x,I.y-g.y);I=g,e.offset(w)}}}()}}else{let t=new paper.Point(e.movementX,e.movementY);appData.drawingCanvas.offset(t.divide(appData.drawingCanvas.getZoom()))}C.toolpreviewmove(appData.drawingCanvas.getTransformedPointer(e.offsetX,e.offsetY))},t.onpointerup=function(e){console.log("onpointerup");let t=appData.drawingCanvas.getTransformedPointer(e.offsetX,e.offsetY);"touch"==e.pointerType?(k=k.filter((t=>{t.pointerId,e.pointerId})),_=_.filter((t=>{t.pointerId,e.pointerId})),I=new DOMPoint(0,0),R="",P=0,C.tool_canceled||C.toolup(t.x,t.y,e.pressure)):C.toolup(t.x,t.y,e.pressure)},t.onwheel=function(e){if(e.preventDefault(),e.ctrlKey)t=e.offsetX,o=e.offsetY,n=1+e.wheelDeltaY,appData.drawingCanvas.zoom(1+.004*n,new paper.Point(t,o));else{let t=.5,o=new paper.Point(e.wheelDeltaX*t,e.wheelDeltaY*t);appData.drawingCanvas.offset(o.divide(appData.drawingCanvas.getZoom()))}var t,o,n},t.onpointerover=b,t.onpointerenter=D,t.addEventListener("touchstart",(e=>{e.preventDefault()}),{passive:!1}),t.addEventListener("gesturestart",(e=>{e.preventDefault()}),{passive:!1}),v=new w,v.selectColor([1,0]),function(){document.getElementById("tool-wheel");let e=document.getElementById("color-picker-canvas").getBoundingClientRect(),t=new T.Point(e.width,e.height);t=t.multiply(.5);let o=document.querySelectorAll(".tool-elements"),n=document.getElementById("settings-button");n.style.left=t.x,n.style.bottom=t.y;let a=t.x+15,i=-Math.PI/10;for(let e=0;e<o.length;e++){console.log(o[e].tagName);let n=o[e],r=e*Math.PI/7+i,s=new T.Point(Math.sin(r)*a,Math.cos(r)*a);n.style.left=t.x+s.x,n.style.bottom=t.y+s.y}for(let e of o)e.id in y&&(e.onclick=function(t){for(let e of o)e.classList.remove("active");var n;C.deactivate(),n=e.id,(C=y[n]).activate(),e.classList.add("active")},C==y[e.id]&&e.classList.add("active"))}(),function(){function e(){let e=document.querySelectorAll("#line-type-selector-button div");for(let t=0;t<4;t++)e[t].style.display=t==m?"block":"none"}document.getElementById("line-type-selector-button").onclick=function(t){m+=1,m%=4,e()},e()}(),window.actions.updateAddRoomList=F}}},e=>{e(e.s=7303)}]);
//# sourceMappingURL=main.bundle.js.map